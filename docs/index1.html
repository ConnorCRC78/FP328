<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ICE Incident Report Mapping Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #info { position: absolute; top: 10px; left: 10px; width: 350px; margin: 10px; padding: 10px; background-color: #ffffff; border-radius: 5px; font-family: Arial, Helvetica, sans-serif; font-size: 12px; line-height: 1.5; color: #000000; z-index: 2; }
    #popup { padding: 10px; }
    #description, #location { width: 100%; margin-bottom: 10px; box-sizing: border-box; }
    #submit { float: right; }
    #data-table { display: block; position: absolute; bottom: 10px; left: 10px; background: #fff; border: 1px solid #ccc; border-radius: 5px; padding: 10px; z-index: 2; width: 350px; font-family: Arial, Helvetica, sans-serif; font-size: 12px; }
    #data-table table { width: 100%; border-collapse: collapse; }
    #data-table th, #data-table td { border: 1px solid #ccc; padding: 4px; text-align: left; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info">
    <h3>ICE Incident Report Heatmap</h3>
    <h4>GDS | University of Washington</h4>
    <p>The intention of this map is to allow users to contribute to a spatial database of reported ICE encounters within the United States, enabling better tracking of potentially dangerous or illicit treatment of residents. Incidents are reported as red dots within the heatmap with additional heading, description, and date/time details. Please see the following for further resources to help stop illegal searches and seizures:<br><i>Last update: March 10th, 2025</i></p>
  </div>
  <div id="data-table">
    <h4>Reported Sightings (Visible Area)</h4>
    <table id="contribution-table">
      <thead><tr><th>Location</th><th>Description</th><th>Date & Time</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let popup = null;
    let geojson = { type: 'FeatureCollection', features: [] };
    let map;

    document.addEventListener('DOMContentLoaded', () => {
      try {
        if (!window.maplibregl) throw new Error('MapLibre GL not loaded');
        map = new maplibregl.Map({
          container: 'map',
          style: 'https://api.maptiler.com/maps/streets-v2/style.json?key=Cusoe5zmfmn26glFoeoe',
          center: [-122.3321, 47.6062],
          zoom: 10
        });

        map.on('load', () => {
          // Sources
          map.addSource('places', { type: 'geojson', data: geojson });
          map.addSource('heatmap', { type: 'geojson', data: geojson });

          // Heatmap layer (disappears below zoom 7)
          map.addLayer({
            id: 'heatmapLayer',
            type: 'heatmap',
            source: 'heatmap',
            minzoom: 7,
            maxzoom: 15,
            paint: {
              'heatmap-weight': 1,
              'heatmap-intensity': ['interpolate', ['linear'], ['zoom'], 0, 1, 15, 3],
              'heatmap-color': [
                'interpolate',
                ['linear'],
                ['heatmap-density'],
                0, 'rgba(128,0,128,0)',
                0.2, 'rgb(75,0,130)',
                0.4, 'rgb(0,0,255)',
                0.6, 'rgb(0,191,255)',
                0.8, 'rgb(135,206,250)',
                1, 'rgb(240,248,255)'
              ],
              'heatmap-radius': ['interpolate', ['linear'], ['zoom'], 7, 10, 15, 30],
              'heatmap-opacity': ['interpolate', ['linear'], ['zoom'], 7, 0, 8, 1, 15, 0.5]
            }
          });

          // Points layer (disappears below zoom 7)
          map.addLayer({
            id: 'places-layer',
            type: 'circle',
            source: 'places',
            minzoom: 7,
            paint: {
              'circle-color': '#B42222',
              'circle-radius': 4,
              'circle-stroke-width': 1,
              'circle-stroke-color': '#000000',
              'circle-opacity': ['interpolate', ['linear'], ['zoom'], 7, 0, 8, 1]
            }
          });

          // Pop-up on existing points (disappears above zoom 13)
          map.on('click', 'places-layer', (e) => {
            if (map.getZoom() > 13) return;
            const { contributor, content, datetime } = e.features[0].properties;
            const coordinates = e.features[0].geometry.coordinates.slice();
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
            popup = new maplibregl.Popup()
              .setLngLat(coordinates)
              .setHTML(`<p><b>${contributor || 'Unknown'}</b>: ${content || 'No description'}<br><small>${datetime || 'N/A'}</small></p>`)
              .addTo(map);
          });

          map.on('mouseenter', 'places-layer', () => map.getCanvas().style.cursor = 'pointer');
          map.on('mouseleave', 'places-layer', () => map.getCanvas().style.cursor = '');
        });

        // Add new point with pop-up (disappears above zoom 13)
        map.on('click', (e) => {
          if (map.getZoom() > 13) return;
          if (popup) popup.remove();
          popup = new maplibregl.Popup({ closeOnClick: true })
            .setLngLat(e.lngLat)
            .setHTML('<div id="popup"><input type="text" id="description" placeholder="Description"><input type="text" id="location" placeholder="Location"><input type="datetime-local" id="datetime"><button id="submit">Submit</button></div>')
            .addTo(map);
          document.getElementById('submit').addEventListener('click', submitNewRecord);
          e.preventDefault();
        });

        // Close pop-up when zooming past 13
        map.on('zoom', () => {
          if (map.getZoom() > 13 && popup) {
            popup.remove();
            popup = null;
          }
        });

        map.on('moveend', updateVisibleTable);
      } catch (error) {
        console.error('Map initialization failed:', error);
        alert('Map failed to load. Check console.');
      }
    });

    function updateVisibleTable() {
      if (!map) return;
      const bounds = map.getBounds();
      const tableBody = document.getElementById('contribution-table').getElementsByTagName('tbody')[0];
      tableBody.innerHTML = '';
      geojson.features.forEach(feature => {
        const coords = feature.geometry.coordinates;
        if (bounds.contains([coords[0], coords[1]]) && feature.properties.contributor && feature.properties.content) {
          const row = tableBody.insertRow();
          row.insertCell(0).textContent = feature.properties.contributor;
          row.insertCell(1).textContent = feature.properties.content;
          row.insertCell(2).textContent = feature.properties.datetime || 'N/A';
        }
      });
    }

    async function submitNewRecord() {
      const contributor = document.getElementById('location').value;
      const content = document.getElementById('description').value;
      const datetime = document.getElementById('datetime').value || new Date().toISOString();
      const lngLat = popup.getLngLat();

      const newRecord = new URLSearchParams({ contributor, content, datetime, lng: lngLat.lng, lat: lngLat.lat });
      try {
        const response = await fetch('https://finalproject328-8bfb306704ea.herokuapp.com/api/add-record', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: newRecord
        });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server error: ${response.status} - ${errorText}`);
        }
        console.log('Record saved:', await response.json());
      } catch (err) {
        console.error('Error saving record:', err);
        alert('Failed to save to server. Data added locally.');
      } finally {
        popup.remove();
        popup = null;
        geojson.features.push({
          type: 'Feature',
          properties: { contributor, content, datetime },
          geometry: { type: 'Point', coordinates: [lngLat.lng, lngLat.lat] }
        });
        if (map && map.getSource('places')) map.getSource('places').setData(geojson);
        if (map && map.getSource('heatmap')) map.getSource('heatmap').setData(geojson);
        updateVisibleTable();
      }
    }

    window.addEventListener('load', async () => {
      try {
        const response = await fetch('https://finalproject328-8bfb306704ea.herokuapp.com/api/get-record');
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Fetch failed: ${response.status} - ${errorText}`);
        }
        const data = await response.json();
        console.log('Fetched data:', data);
        data.rows.forEach(record => {
          geojson.features.push({
            type: 'Feature',
            properties: { contributor: record.contributor, content: record.content, datetime: record.datetime || '' },
            geometry: { type: 'Point', coordinates: [record.lng, record.lat] }
          });
        });
        if (map && map.getSource('places')) map.getSource('places').setData(geojson);
        if (map && map.getSource('heatmap')) map.getSource('heatmap').setData(geojson);
        updateVisibleTable();
      } catch (error) {
        console.error('Error fetching records:', error);
      }
    });
  </script>
</body>
</html>
